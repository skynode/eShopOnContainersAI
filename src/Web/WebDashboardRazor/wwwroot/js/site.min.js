function onLoadProductForecasting(){setResponsivePlots();setUpProductDescriptionTypeahead();$("footer").addClass("sticky")}function setResponsivePlots(n=".responsive-plot"){var i=Plotly.d3,r=i.selectAll(n),t=r[0];window.onresize=function(){for(var n=0;n<t.length;n++)Plotly.Plots.resize(t[n])}}function setUpProductDescriptionTypeahead(n="#remote .typeahead"){var t=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.obj.whitespace("value"),queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:`${apiUri.catalog}?description=%QUERY`,wildcard:"%QUERY"}});$(n).typeahead({minLength:3,highlight:!0},{name:"products",display:"description",limit:10,source:t}).on("typeahead:selected",function(n,t){updateProductInfo(t);getProductData(t)})}function updateProductInfo(n){$("#product").removeClass("d-none");$("#productName").text(n.description);$("#productPrice").text(`${n.price.toCurrencyLocaleString()}`);$("#productImage").attr("src",n.pictureUri).attr("alt",n.description)}function getProductData(n){productId=n.id;description=n.description;getHistory(productId).done(function(t){var i=(new Date).getFullYear();t=t.filter(n=>n.year!=i);$.when(getForecast(t[t.length-1],n)).done(function(i){plotLineChart(i,t,description,n.price)})})}function getForecast(n){var t=`?month=${n.month}&year=${n.year}&avg=${n.avg}&max=${n.max}&min=${n.min}&count=${n.count}&prev=${n.prev}&units=${n.units}`;return $.getJSON(`${apiUri.forecasting}/product/${n.productId}/unitdemandestimation${t}`)}function getHistory(n){return $.getJSON(`${apiUri.ordering}/product/${n}/history`)}function getStats(n){return $.getJSON(`${apiUri.ordering}/product/${n}/stats`)}function plotLineChart(n,t,r,u){for(i=0;i<t.length;i++)t[i].sales=t[i].units*u;n*=u;$("footer").removeClass("sticky");updateProductStatistics(r,t,n);var f=TraceProductHistory(t),e=TraceProductForecast(f.x,nextMonth(t[t.length-1]),nextFullMonth(t[t.length-1]),f.text[f.text.length-1],f.y,n),o=TraceMean(f.x.concat(e.x),f.y,"#ffcc33"),s={xaxis:{tickangle:0,showgrid:!1,showline:!1,zeroline:!1,range:[0,f.x.length]},yaxis:{showgrid:!1,showline:!1,zeroline:!1,tickformat:"$,.0"},hovermode:"closest",legend:{orientation:"h",xanchor:"center",yanchor:"top",y:1.2,x:.85}};Plotly.newPlot("lineChart",[f,e,o],s)}function TraceProductHistory(n){var t=$.map(n,function(n){return n.sales}),i=$.map(n,function(n){return`${months[n.month]}<br>${n.year}`}),r=$.map(n,function(n){return`${full_months[n.month]}<br><b>${n.sales.toCurrencyLocaleString()}</b>`});return{x:i,y:t,mode:"lines+markers",name:"history",line:{shape:"spline",color:"#dd1828"},hoveron:"points",hoverinfo:"text",hoverlabel:{bgcolor:"#333333",bordercolor:"#333333",font:{color:"white"}},text:r,fill:"tozeroy",fillcolor:"#dd1828",marker:{symbol:"circle",color:"white",size:10,line:{color:"black",width:3}}}}function TraceProductForecast(n,t,i,r,u,f){return{x:[n[n.length-1],t],y:[u[u.length-1],f],text:[r,`${i}<br><b>${f.toCurrencyLocaleString()}</b>`],mode:"lines+markers",name:"forecasting",hoveron:"points",hoverinfo:"text",hoverlabel:{bgcolor:"#333333",bordercolor:"#333333",font:{color:"white"}},line:{shape:"spline",color:"#00A69C"},fill:"tozeroy",fillcolor:"#00A69C",marker:{symbol:"circle",color:"white",size:10,line:{color:"black",width:3}}}}function TraceMean(n,t,i){var r=t.slice(0,t.length-2).reduce((n,t)=>t+=n)/t.length;return{x:n,y:Array(n.length).fill(r),name:"average",mode:"lines",hoverinfo:"none",line:{color:i,width:3}}}function nextMonth(n){return n.month===12?`${months[1]}<br>${n.year+1}`:`${months[n.month+1]}<br>${n.year}`}function nextFullMonth(n,t=false){return n.month===12?`${full_months[1]}`:`${full_months[n.month+1]}${t?" "+n.year:""}`}function onLoadCountryForecasting(){setResponsivePlots();$("footer").addClass("sticky")}function getCountryData(n){$.getJSON(`${apiUri.ordering}/country/${n}/history`).done(function(t){var i=(new Date).getFullYear();t=t.filter(n=>n.year!=i);$.when(getCountryForecast(t[t.length-1])).done(function(i){plotLineChartCountry(i,t,n)})})}function getCountryForecast(n){var t=`?month=${n.month}&year=${n.year}&avg=${n.avg}&max=${n.max}&min=${n.min}&prev=${n.prev}&count=${n.count}&med=${n.med}&sales=${n.sales}&std=${n.std}`;return $.getJSON(`${apiUri.forecasting}/country/${n.country}/salesforecast${t}`)}function plotLineChartCountry(n,t,i){n=Math.pow(10,n);$("footer").removeClass("sticky");updateCountryStatistics(i,t,n);var r=getTraceCountryHistory(t),u=getTraceCountryForecast(r.x,nextMonth(t[t.length-1]),nextFullMonth(t[t.length-1]),r.text[r.text.length-1],r.y,n),f=TraceMean(r.x.concat(u.x),r.y,"#999999"),e={xaxis:{tickangle:0,showgrid:!1,showline:!1,zeroline:!1,range:[0,r.x.length]},yaxis:{showgrid:!1,showline:!1,zeroline:!1,tickformat:"$,.0"},hovermode:"closest",legend:{orientation:"h",xanchor:"center",yanchor:"top",y:1.2,x:.85}};Plotly.newPlot("lineChart",[r,u,f],e)}function getTraceCountryHistory(n){var t=$.map(n,function(n){return n.sales}),i=$.map(n,function(n){return`${months[n.month]}<br>${n.year}`}),r=$.map(n,function(n){return`${full_months[n.month]}<br><b>${n.sales.toCurrencyLocaleString()}</b>`});return{x:i,y:t,mode:"lines+markers",name:"history",line:{shape:"spline",color:"#ffb131"},hoveron:"points",hoverinfo:"text",hoverlabel:{bgcolor:"#333333",bordercolor:"#333333",font:{color:"white"}},text:r,fill:"tozeroy",fillcolor:"#ffb131",marker:{symbol:"circle",color:"white",size:10,line:{color:"black",width:3}}}}function getTraceCountryForecast(n,t,i,r,u,f){return{x:[n[n.length-1],t],y:[u[u.length-1],f],text:[r,`${i}<br><b>${f.toCurrencyLocaleString()}</b>`],mode:"lines+markers",name:"forecasting",hoveron:"points",hoverinfo:"text",hoverlabel:{bgcolor:"#333333",bordercolor:"#333333",font:{color:"white"}},line:{shape:"spline",color:"#00A69C"},fill:"tozeroy",fillcolor:"#00A69C",marker:{symbol:"circle",color:"white",size:10,line:{color:"black",width:3}}}}function updateProductStatistics(n,t,i){showStatsLayers();populateForecastDashboard(n,t,i);populateHistoryTable(t);refreshHeightSidebar()}function updateCountryStatistics(n,t,i){showStatsLayers();populateForecastDashboard(n,t,i);populateHistoryTable(t);refreshHeightSidebar()}function showStatsLayers(){$("#plot,#tableHeader,#tableHistory").removeClass("d-none")}function populateForecastDashboard(n,t,i,r=false){var u=t[t.length-1].year,e=t.map(n=>n.year===u?n.sales:0),f=e.reduce((n,t)=>t+=n);$("#labelTotal").text(`${u} sales`);$("#valueTotal").text(r?f.toNumberLocaleString():f.toCurrencyLocaleString());$("#labelForecast").text(`${nextFullMonth(t[t.length-1],!0).toLowerCase()} sales`);$("#valueForecast").text(r?i.toNumberLocaleString():i.toCurrencyLocaleString());$("#labelItem").text(n);$("#tableHeaderCaption").text(`Sales ${r?"units":1..toCurrencyLocaleString().replace("1.00","")} / month`)}function populateHistoryTable(n){var t="",r="";for(i=0;i<n.length;i++)n[i].year!==r&&(r=n[i].year,t+=`<div class="col-11 border-bottom-highlight-table month font-weight-bold">${r}</div>`),t+=`<div class="col-8 border-bottom-highlight-table month">${full_months[n[i].month]}</div> <div class="col-3 border-bottom-highlight-table">${n[i].sales.toLocaleString()}</div >`;$("#historyTable").empty().append($(t))}function refreshHeightSidebar(){$("aside").css("height",$(document).height())}var months=["","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],full_months=["","January","February","March","April","May","June","July","August","September","October","November","December"];Number.prototype.toCurrencyLocaleString=function(){var n=navigator.languages?navigator.languages[0]:navigator.language;return this.toLocaleString(n,{style:"currency",currency:"USD"})};Number.prototype.toNumberLocaleString=function(){var n=navigator.languages?navigator.languages[0]:navigator.language;return this.toLocaleString(n,{useGrouping:!0})+" units"};